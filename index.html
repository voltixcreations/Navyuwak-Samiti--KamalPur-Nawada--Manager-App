<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Navyuvak Samiti (Kamalpur) ‚Äì Admin Donation Management</title>

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .accordion-content { display: none; }
    .accordion.open .accordion-content { display: block; }
    td.editing { background: #fffceb; outline: none; }
    .chip { display: inline-block; padding: .25rem .75rem; border-radius: .5rem; background: #eef2ff; font-size: .75rem; }
    .btn-secondary { background: #e5e7eb; }
    .btn-secondary:hover { background: #d1d5db; }
    /* Enhanced Mobile-specific styles */
    @media (max-width: 640px) {
      body { font-size: 16px; } /* Base font size for readability */
      .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      table { min-width: 1000px; } /* Wider min-width for more columns */
      input, select, button { font-size: 16px; min-height: 48px; } /* Touch-friendly sizes */
      .toggle-acc { font-size: 1rem; padding: 1rem; }
      .chip { font-size: 0.7rem; }
      .accordion-content { padding: 1rem; }
      .grid { gap: 0.75rem; }
      .space-y-6 > * + * { margin-top: 1.5rem; }
      /* Card-like sections for better mobile feel */
      section { margin-bottom: 1rem; border-radius: 1rem; overflow: hidden; }
      header { padding: 0.75rem; }
      .flex-col { flex-direction: column; }
    }
    /* General improvements */
    body { font-family: 'Inter', sans-serif; }
    button { transition: all 0.2s ease; }
    input:focus, select:focus { ring: 2px solid #3b82f6; }
  </style>
  <!-- Google Fonts for better typography -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-900">

  <!-- ============================ LOGIN ============================ -->
  <section id="loginSection" class="min-h-screen flex items-center justify-center p-4 sm:p-6 bg-gradient-to-br from-blue-50 to-indigo-50">
    <div class="w-full max-w-sm bg-white shadow-2xl rounded-3xl p-6 sm:p-8 transform transition-all hover:scale-105">
      <div class="text-center mb-8">
        <img src="nsk.jpg" alt="Logo" class="mx-auto h-20 w-20 rounded-full object-cover mb-4 shadow-md">
        <h1 class="text-3xl font-bold text-blue-800">üîê Admin Login</h1>
        <p class="text-sm text-gray-600 mt-2">Navyuvak Samiti (Kamalpur)</p>
      </div>
      <form id="loginForm" class="space-y-6">
        <input id="email" type="email" placeholder="Admin Email"
               class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-base bg-gray-50" required>
        <input id="password" type="password" placeholder="Password"
               class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-base bg-gray-50" required>
        <button type="submit"
                class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-4 rounded-xl transition shadow-md">
          Login
        </button>
      </form>
      <p class="mt-6 text-xs text-center text-gray-500">
        Tip: Enable Email/Password auth in Firebase and create your admin user.
      </p>
    </div>
  </section>

  <!-- ============================ DASHBOARD ============================ -->
  <section id="dashboardSection" class="hidden">
    <!-- Topbar -->
    <header class="bg-white shadow-md sticky top-0 z-10">
      <div class="w-full max-w-7xl mx-auto px-4 sm:px-6 py-3 flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <img src="nsk.jpg" alt="Logo" class="h-12 w-12 rounded-full object-cover shadow">
          <div>
            <h2 class="text-xl sm:text-2xl font-bold text-blue-800">üìä Navyuvak Samiti Kamalpur</h2>
            <p class="text-sm text-gray-600">Admin Dashboard - Donation Management</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <span id="userEmail" class="text-sm text-gray-600"></span>
          <button id="logoutBtn"
                  class="bg-red-500 hover:bg-red-600 text-white px-5 py-2.5 rounded-xl text-sm shadow">Logout</button>
        </div>
      </div>
    </header>

    <main class="w-full max-w-7xl mx-auto p-4 sm:p-6 space-y-8">
      <!-- ====== Analytics ====== -->
      <section class="bg-white rounded-2xl shadow-lg overflow-hidden">
        <div class="accordion open">
          <button class="w-full text-left px-5 py-4 font-semibold flex justify-between items-center toggle-acc bg-gradient-to-r from-blue-50 to-indigo-50">
            <span class="text-lg">üìà Analytics</span>
            <span class="chip bg-blue-100 text-blue-800">Auto-updates</span>
          </button>
          <div class="accordion-content px-5 py-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
              <div class="bg-blue-100 p-4 rounded-xl text-center shadow">
                <div id="statTotalCount" class="text-4xl font-bold text-blue-800">0</div>
                <div class="text-sm text-gray-700">Total Donations</div>
              </div>
              <div class="bg-green-100 p-4 rounded-xl text-center shadow">
                <div id="statTotalAmount" class="text-4xl font-bold text-green-800">‚Çπ0</div>
                <div class="text-sm text-gray-700">Total Amount</div>
              </div>
              <div class="bg-yellow-100 p-4 rounded-xl text-center shadow">
                <div id="statToday" class="text-4xl font-bold text-yellow-800">0 (‚Çπ0)</div>
                <div class="text-sm text-gray-700">Today</div>
              </div>
              <div class="bg-indigo-100 p-4 rounded-xl text-center shadow">
                <div id="statByEvent" class="text-sm font-mono overflow-y-auto max-h-32 text-indigo-800"></div>
                <div class="text-sm text-gray-700 mt-2">By Event</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ====== Donation Records ====== -->
      <section class="bg-white rounded-2xl shadow-lg overflow-hidden">
        <div class="accordion open">
          <button class="w-full text-left px-5 py-4 font-semibold flex justify-between items-center toggle-acc bg-gradient-to-r from-green-50 to-emerald-50">
            <span class="text-lg">üßæ Donation Records</span>
            <span class="chip bg-green-100 text-green-800">Add/Filter/Edit/Export</span>
          </button>
          <div class="accordion-content px-5 py-6">
            <!-- Add Donation -->
            <div class="bg-gray-100 border border-gray-200 rounded-2xl p-5 mb-5 shadow-inner">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-lg text-green-800">‚ûï Add Donation</h3>
                <span class="text-xs text-gray-600">IST & Auto TRX</span>
              </div>
              <form id="donationForm" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4">
                <input id="donorName" class="p-3 border border-gray-300 rounded-xl bg-white" placeholder="Donor Name" required>
                <input id="amount" type="number" min="1" step="1" class="p-3 border border-gray-300 rounded-xl bg-white" placeholder="Amount (‚Çπ)" required>
                <select id="event" class="p-3 border border-gray-300 rounded-xl bg-white" required></select>
                <select id="paymentMethod" class="p-3 border border-gray-300 rounded-xl bg-white" required>
                  <option value="Cash">Cash</option>
                  <option value="UPI">UPI</option>
                  <option value="Bank Transfer">Bank Transfer</option>
                </select>
                <div class="sm:col-span-2">
                  <label class="text-xs text-gray-600 block mb-1">Date & Time (IST)</label>
                  <input id="dateTimeInput" type="datetime-local" class="p-3 border border-gray-300 rounded-xl w-full bg-white">
                </div>
                <input id="phone" class="p-3 border border-gray-300 rounded-xl bg-white" placeholder="Phone (optional)">
                <input id="emailDonor" type="email" class="p-3 border border-gray-300 rounded-xl bg-white" placeholder="Email (optional)">
                <input id="address" class="sm:col-span-2 p-3 border border-gray-300 rounded-xl bg-white" placeholder="Address (optional)">
                <button type="submit"
                        class="sm:col-span-2 md:col-span-5 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold py-4 rounded-xl shadow">
                  Save Donation
                </button>
              </form>
            </div>

            <!-- Filters -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4 items-end mb-4">
              <input id="searchText" class="p-3 border border-gray-300 rounded-xl bg-white" placeholder="Search donor / phone / email">
              <select id="filterEvent" class="p-3 border border-gray-300 rounded-xl bg-white"></select>
              <div>
                <label class="text-xs text-gray-600 block mb-1">Start Date</label>
                <input id="startDate" type="date" class="p-3 border border-gray-300 rounded-xl w-full bg-white">
              </div>
              <div>
                <label class="text-xs text-gray-600 block mb-1">End Date</label>
                <input id="endDate" type="date" class="p-3 border border-gray-300 rounded-xl w-full bg-white">
              </div>
              <div class="flex gap-3 sm:col-span-2 md:col-span-1">
                <button id="applyFilters" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-xl shadow">Apply</button>
                <button id="clearFilters" class="flex-1 btn-secondary text-gray-800 px-4 py-3 rounded-xl shadow">Clear</button>
              </div>
            </div>

            <div class="flex flex-wrap gap-3 mb-4">
              <button id="downloadCSV"
                      class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-xl text-sm shadow">
                CSV (filtered)
              </button>
              <button id="downloadPDF"
                      class="bg-purple-500 hover:bg-purple-600 text-white px-5 py-2.5 rounded-xl text-sm shadow">
                PDF Report (filtered)
              </button>
              <span id="recordsCount" class="text-sm text-gray-600 self-center"></span>
            </div>

            <!-- Donation Table -->
            <div class="table-container border border-gray-200 rounded-2xl overflow-hidden bg-white shadow">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100 text-xs uppercase">
                  <tr>
                    <th class="px-4 py-3 text-left text-gray-600">Txn ID</th>
                    <th class="px-4 py-3 text-left text-gray-600">Date (IST)</th>
                    <th class="px-4 py-3 text-left text-gray-600">Donor</th>
                    <th class="px-4 py-3 text-left text-gray-600">‚Çπ Amount</th>
                    <th class="px-4 py-3 text-left text-gray-600">Event</th>
                    <th class="px-4 py-3 text-left text-gray-600">Method</th>
                    <th class="px-4 py-3 text-left text-gray-600">Phone</th>
                    <th class="px-4 py-3 text-left text-gray-600">Email</th>
                    <th class="px-4 py-3 text-left text-gray-600">Address</th>
                    <th class="px-4 py-3 text-left text-gray-600">Actions</th>
                  </tr>
                </thead>
                <tbody id="donationTableBody" class="text-sm divide-y divide-gray-200"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- ====== Event Management ====== -->
      <section class="bg-white rounded-2xl shadow-lg overflow-hidden">
        <div class="accordion">
          <button class="w-full text-left px-5 py-4 font-semibold flex justify-between items-center toggle-acc bg-gradient-to-r from-purple-50 to-violet-50">
            <span class="text-lg">üéâ Event Management</span>
            <span class="chip bg-purple-100 text-purple-800">Active in forms</span>
          </button>
          <div class="accordion-content px-5 py-6">
            <form id="eventForm" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-5">
              <input id="eventName" class="p-3 border border-gray-300 rounded-xl bg-white" placeholder="Event Name" required>
              <select id="eventStatus" class="p-3 border border-gray-300 rounded-xl bg-white">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
              <button class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 rounded-xl shadow">Add Event</button>
            </form>

            <div class="table-container border border-gray-200 rounded-2xl overflow-hidden bg-white shadow">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100 text-xs uppercase">
                  <tr>
                    <th class="px-4 py-3 text-left text-gray-600">Event Name</th>
                    <th class="px-4 py-3 text-left text-gray-600">Status</th>
                    <th class="px-4 py-3 text-left text-gray-600">Actions</th>
                  </tr>
                </thead>
                <tbody id="eventsTableBody" class="text-sm divide-y divide-gray-200"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- ====== Data Management ====== -->
      <section class="bg-white rounded-2xl shadow-lg overflow-hidden">
        <div class="accordion">
          <button class="w-full text-left px-5 py-4 font-semibold flex justify-between items-center toggle-acc bg-gradient-to-r from-red-50 to-rose-50">
            <span class="text-lg">üßπ Data Management</span>
            <span class="chip bg-red-100 text-red-800">Danger Zone</span>
          </button>
          <div class="accordion-content px-5 py-6">
            <div class="space-y-4">
              <button id="resetCounterBtn"
                      class="bg-amber-500 hover:bg-amber-600 text-white px-5 py-3 rounded-xl w-full sm:w-auto shadow">
                Reset Transaction Counter
              </button>
              <button id="restoreDefaultEventsBtn"
                      class="bg-sky-500 hover:bg-sky-600 text-white px-5 py-3 rounded-xl w-full sm:w-auto shadow">
                Restore Default Events
              </button>
              <button id="clearAllDataBtn"
                      class="bg-red-500 hover:bg-red-600 text-white px-5 py-3 rounded-xl w-full sm:w-auto shadow">
                Clear ALL Donations & Non-default Events
              </button>
              <div class="text-xs text-gray-600">
                Defaults: "Saraswati Puja", "General Fund", "Other" (Active)
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </section>

  <!-- Firebase v8 SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // ================== Firebase Config ==================
    const firebaseConfig = {
      apiKey: "AIzaSyBk9kfv9_rzcxgyxf60A92UDgOWSLYsdh8",
      authDomain: "donation-management-8598a.firebaseapp.com",
      projectId: "donation-management-8598a",
      storageBucket: "donation-management-8598a.appspot.com",
      messagingSenderId: "616961540877",
      appId: "1:616961540877:web:37d56aa10381807aaf2644",
      measurementId: "G-11TNRYNWRK"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ================== UI & State ==================
    const loginSection = document.getElementById('loginSection');
    const dashboardSection = document.getElementById('dashboardSection');
    const userEmailEl = document.getElementById('userEmail');

    // Accordions
    document.querySelectorAll('.toggle-acc').forEach(btn=>{
      btn.addEventListener('click', ()=>btn.parentElement.classList.toggle('open'));
    });

    // IST helpers & money
    const pad = n => String(n).padStart(2,'0');
    function toISTISOString(d = new Date()) {
      const utc = d.getTime() + d.getTimezoneOffset()*60000;
      const ist = new Date(utc + 5.5*3600000);
      return `${ist.getFullYear()}-${pad(ist.getMonth()+1)}-${pad(ist.getDate())}T${pad(ist.getHours())}:${pad(ist.getMinutes())}:${pad(ist.getSeconds())}+05:30`;
    }
    // For datetime-local input value (no seconds, no TZ)
    function istLocalForInput(d = new Date()) {
      const utc = d.getTime() + d.getTimezoneOffset()*60000;
      const ist = new Date(utc + 5.5*3600000);
      return `${ist.getFullYear()}-${pad(ist.getMonth()+1)}-${pad(ist.getDate())}T${pad(ist.getHours())}:${pad(ist.getMinutes())}`;
    }
    function inputToISTISO(inputVal) {
      // from "YYYY-MM-DDTHH:mm" ‚Üí add ":00+05:30"
      if (!inputVal) return toISTISOString();
      return `${inputVal}:00+05:30`;
    }
    function formatINR(n) { return new Intl.NumberFormat('en-IN').format(Number(n||0)); }

    // Collections
    const donationsCol = () => db.collection('donations');
    const eventsCol    = () => db.collection('events');
    const metaDoc      = () => db.collection('meta').doc('counters');

    // State caches
    let allDonations = [];
    let filtered = [];
    let allEvents = [];
    let logoDataUrl = null; // base64 for receipts

    // ================== Auth Flow ==================
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        loginSection.classList.add('hidden');
        dashboardSection.classList.remove('hidden');
        userEmailEl.textContent = user.email || '';

        await preloadLogo();
        await ensureDefaultEvents();
        await refreshAll();
        // default date-time in form
        document.getElementById('dateTimeInput').value = istLocalForInput();
        renderAfterFilters();
      } else {
        loginSection.classList.remove('hidden');
        dashboardSection.classList.add('hidden');
        userEmailEl.textContent = '';
      }
    });

    document.getElementById('loginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password)
        .catch(err => alert('Login failed: ' + err.message));
    });
    document.getElementById('logoutBtn').addEventListener('click', ()=>auth.signOut());

    // ================== Preload logo for receipts ==================
    async function preloadLogo() {
      try {
        const img = await loadImage('nsk.jpg');
        logoDataUrl = imageToDataURL(img);
      } catch (e) {
        console.warn('Logo load failed, receipts will be without logo.', e);
        logoDataUrl = null;
      }
    }
    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const im = new Image();
        im.crossOrigin = 'anonymous';
        im.onload = ()=>resolve(im);
        im.onerror = reject;
        im.src = src + (src.includes('?') ? '&' : '?') + 'cachebust=' + Date.now();
      });
    }
    function imageToDataURL(img) {
      const canvas = document.createElement('canvas');
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      return canvas.toDataURL('image/jpeg'); // nsk.jpg
    }

    // ================== Default Events ==================
    async function ensureDefaultEvents() {
      const defaults = ["Saraswati Puja","General Fund","Other"];
      const snaps = await eventsCol().get();
      if (snaps.empty) {
        for (const name of defaults) {
          await eventsCol().add({ name, status: "Active", createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        }
      }
    }

    // ================== Loaders ==================
    async function refreshAll() {
      const [dSnap, eSnap] = await Promise.all([
        donationsCol().orderBy('createdAt','desc').get(),
        eventsCol().orderBy('name').get()
      ]);
      allDonations = dSnap.docs.map(d=>({ id:d.id, ...d.data() }));
      allEvents    = eSnap.docs.map(d=>({ id:d.id, ...d.data() }));
      renderEventsUI();
    }

    // ================== Donation: Create ==================
    const donationForm = document.getElementById('donationForm');
    donationForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const donorName = document.getElementById('donorName').value.trim();
      const amount = Number(document.getElementById('amount').value);
      const eventId = document.getElementById('event').value;
      const paymentMethod = document.getElementById('paymentMethod').value;
      const dateTimeInput = document.getElementById('dateTimeInput').value; // "YYYY-MM-DDTHH:mm"
      const phone = document.getElementById('phone').value.trim();
      const emailDonor = document.getElementById('emailDonor').value.trim();
      const address = document.getElementById('address').value.trim();

      if (!donorName || !amount || !eventId) return alert('Please fill Donor, Amount, and Event');

      try {
        const transactionId = await nextTransactionId();
        const dateTimeISO = inputToISTISO(dateTimeInput);
        const eventName = (allEvents.find(e=>e.id===eventId)||{}).name || '';

        await donationsCol().add({
          transactionId, dateTimeISO,
          donorName, amount, event: eventName, eventId,
          paymentMethod, phone, email: emailDonor, address,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        await refreshAll();
        renderAfterFilters();
        donationForm.reset();
        document.getElementById('dateTimeInput').value = istLocalForInput(); // re-seed IST now

        // Auto-generate receipt
        const just = allDonations.find(x=>x.transactionId===transactionId);
        if (just) generateReceiptPDF(just);

      } catch(err){ alert('Failed to save: ' + err.message); }
    });

    async function nextTransactionId() {
      let trxNum = 0;
      await db.runTransaction(async (tx)=>{
        const snap = await tx.get(metaDoc());
        if (!snap.exists) {
          tx.set(metaDoc(), { lastTrx: 0 });
          trxNum = 1;
        } else {
          const last = Number(snap.data().lastTrx||0);
          trxNum = last + 1;
          tx.update(metaDoc(), { lastTrx: trxNum });
        }
      });
      return `TRX-${String(trxNum).padStart(3,'0')}`;
    }

    // ================== Donation: Table/Filters ==================
    const tableBody = document.getElementById('donationTableBody');
    const recordsCount = document.getElementById('recordsCount');
    const searchText = document.getElementById('searchText');
    const filterEvent = document.getElementById('filterEvent');
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');
    document.getElementById('applyFilters').addEventListener('click', renderAfterFilters);
    document.getElementById('clearFilters').addEventListener('click', ()=>{
      searchText.value = ''; filterEvent.value=''; startDate.value=''; endDate.value='';
      renderAfterFilters();
    });

    function applyClientFilters() {
      const q = (searchText.value||'').trim().toLowerCase();
      const ev = filterEvent.value;
      const sd = startDate.value ? new Date(startDate.value+'T00:00:00Z') : null;
      const ed = endDate.value ? new Date(endDate.value+'T23:59:59Z') : null;

      filtered = allDonations.filter(d=>{
        const hay = `${d.donorName||''} ${d.phone||''} ${d.email||''}`.toLowerCase();
        if (q && !hay.includes(q)) return false;
        if (ev && d.eventId !== ev) return false;
        const when = new Date(d.dateTimeISO.replace('+05:30','Z'));
        if (sd && when < sd) return false;
        if (ed && when > ed) return false;
        return true;
      });
    }

    function renderTable() {
      tableBody.innerHTML = '';
      filtered.forEach(d=>{
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';

        tr.innerHTML = `
          <td class="px-4 py-3">${d.transactionId||''}</td>
          <td class="px-4 py-3" data-field="dateTimeISO" data-id="${d.id}">${d.dateTimeISO||''}</td>
          <td class="px-4 py-3" data-field="donorName"  data-id="${d.id}">${d.donorName||''}</td>
          <td class="px-4 py-3" data-field="amount"     data-id="${d.id}">${d.amount||''}</td>
          <td class="px-4 py-3" data-field="event"      data-id="${d.id}">${d.event||''}</td>
          <td class="px-4 py-3" data-field="paymentMethod" data-id="${d.id}">${d.paymentMethod||''}</td>
          <td class="px-4 py-3" data-field="phone"      data-id="${d.id}">${d.phone||''}</td>
          <td class="px-4 py-3" data-field="email"      data-id="${d.id}">${d.email||''}</td>
          <td class="px-4 py-3" data-field="address"    data-id="${d.id}">${d.address||''}</td>
          <td class="px-4 py-3 whitespace-nowrap">
            <button class="text-blue-600 hover:text-blue-800 mr-2" data-action="receipt" data-id="${d.id}">Receipt</button>
            <button class="text-amber-600 hover:text-amber-800 mr-2" data-action="edit" data-id="${d.id}">Edit</button>
            <button class="text-green-600 hover:text-green-800 mr-2 hidden" data-action="save" data-id="${d.id}">Save</button>
            <button class="text-gray-600 hover:text-gray-800 mr-2 hidden" data-action="cancel" data-id="${d.id}">Cancel</button>
            <button class="text-red-600 hover:text-red-800" data-action="delete" data-id="${d.id}">Delete</button>
          </td>
        `;
        tableBody.appendChild(tr);
      });
      recordsCount.textContent = `${filtered.length} record(s) shown`;
      updateAnalyticsCards();
    }

    function renderAfterFilters() { applyClientFilters(); renderTable(); }

    // ===== Row Edit/Save/Cancel/Actions =====
    tableBody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if (!btn) return;
      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');
      const donation = allDonations.find(x=>x.id===id); if (!donation) return;

      if (action==='receipt') {
        generateReceiptPDF(donation);
        return;
      }
      if (action==='delete') {
        const ok = confirm(`Delete donation ${donation.transactionId}?`);
        if (!ok) return;
        await donationsCol().doc(id).delete();
        await refreshAll();
        renderAfterFilters();
        return;
      }
      if (action==='edit') {
        enterEditMode(id);
        return;
      }
      if (action==='cancel') {
        exitEditMode(id, true); // revert
        return;
      }
      if (action==='save') {
        await saveRow(id);
        return;
      }
    });

    function enterEditMode(id) {
      const row = [...tableBody.querySelectorAll('tr')].find(tr => tr.querySelector(`[data-id="${id}"]`));
      if (!row) return;
      row.querySelectorAll('[data-field]').forEach(td=>{
        const field = td.getAttribute('data-field');
        const val = td.textContent.trim();

        // Turn into inputs (keep simple)
        if (field === 'dateTimeISO') {
          // Convert "YYYY-MM-DDTHH:mm:ss+05:30" -> "YYYY-MM-DDTHH:mm"
          const v = (val||'').slice(0,16);
          td.innerHTML = `<input class="w-full p-1 border rounded" type="datetime-local" value="${v}" />`;
        } else if (field === 'amount') {
          td.innerHTML = `<input class="w-full p-1 border rounded" type="number" step="1" min="0" value="${val||0}" />`;
        } else if (field === 'paymentMethod') {
          td.innerHTML = `
            <select class="w-full p-1 border rounded">
              <option ${val==='Cash'?'selected':''}>Cash</option>
              <option ${val==='UPI'?'selected':''}>UPI</option>
              <option ${val==='Bank Transfer'?'selected':''}>Bank Transfer</option>
            </select>`;
        } else if (field === 'event') {
          // Build a select of all events (show current selected by name)
          const options = allEvents.map(ev => `<option ${ev.name===val?'selected':''}>${ev.name}</option>`).join('');
          td.innerHTML = `<select class="w-full p-1 border rounded">${options}</select>`;
        } else {
          td.innerHTML = `<input class="w-full p-1 border rounded" type="text" value="${val}" />`;
        }
        td.classList.add('editing');
      });
      toggleRowButtons(row, {editing:true});
    }

    function exitEditMode(id, revert=false) {
      const row = [...tableBody.querySelectorAll('tr')].find(tr => tr.querySelector(`[data-id="${id}"]`));
      if (!row) return;
      row.querySelectorAll('[data-field]').forEach(td=>{
        if (revert) {
          // restore from allDonations (truth)
          const field = td.getAttribute('data-field');
          const d = allDonations.find(x=>x.id===id);
          td.textContent = field==='dateTimeISO' ? d.dateTimeISO :
                           field==='donorName'  ? (d.donorName||'') :
                           field==='amount'     ? (d.amount||'') :
                           field==='event'      ? (d.event||'') :
                           field==='paymentMethod'? (d.paymentMethod||'') :
                           field==='phone'      ? (d.phone||'') :
                           field==='email'      ? (d.email||'') :
                           field==='address'    ? (d.address||'') : '';
        } else {
          // keep whatever is there (already updated)
        }
        td.classList.remove('editing');
      });
      toggleRowButtons(row, {editing:false});
    }

    function toggleRowButtons(row, {editing}) {
      row.querySelectorAll('[data-action="edit"]').forEach(b=>b.classList.toggle('hidden', editing));
      row.querySelectorAll('[data-action="save"]').forEach(b=>b.classList.toggle('hidden', !editing));
      row.querySelectorAll('[data-action="cancel"]').forEach(b=>b.classList.toggle('hidden', !editing));
      row.querySelectorAll('[data-action="delete"]').forEach(b=>b.classList.toggle('hidden', editing));
      row.querySelectorAll('[data-action="receipt"]').forEach(b=>b.classList.toggle('hidden', editing));
    }

    async function saveRow(id) {
      const row = [...tableBody.querySelectorAll('tr')].find(tr => tr.querySelector(`[data-id="${id}"]`));
      if (!row) return;
      const getVal = (field) => {
        const td = row.querySelector(`[data-field="${field}"][data-id="${id}"]`);
        if (!td) return '';
        const input = td.querySelector('input,select');
        if (!input) return td.textContent.trim();
        let v = input.value;
        if (field==='dateTimeISO') v = inputToISTISO(input.value);
        if (field==='amount') v = Number(v||0);
        return v;
      };

      const updated = {
        dateTimeISO: getVal('dateTimeISO'),
        donorName: getVal('donorName'),
        amount: getVal('amount'),
        event: getVal('event'),
        paymentMethod: getVal('paymentMethod'),
        phone: getVal('phone'),
        email: getVal('email'),
        address: getVal('address'),
      };

      // keep eventId consistent if event name matches existing
      const matchEv = allEvents.find(ev => ev.name === updated.event);
      if (matchEv) updated.eventId = matchEv.id;

      // basic validations
      if (!updated.donorName) return alert('Donor name is required');
      if (!updated.amount || updated.amount <= 0) return alert('Amount must be > 0');
      if (!/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\+05:30$/.test(updated.dateTimeISO)) {
        return alert('Invalid IST datetime. Example: 2025-08-17T13:57:00+05:30');
      }

      await donationsCol().doc(id).update(updated);
      // update local cache
      const idx = allDonations.findIndex(x=>x.id===id);
      if (idx>-1) allDonations[idx] = { ...allDonations[idx], ...updated };

      // re-render row in view mode
      exitEditMode(id, /*revert*/ false);
      // rewrite the cells with fresh values
      const d = allDonations.find(x=>x.id===id);
      row.querySelector(`[data-field="dateTimeISO"]`).textContent = d.dateTimeISO;
      row.querySelector(`[data-field="donorName"]`).textContent  = d.donorName||'';
      row.querySelector(`[data-field="amount"]`).textContent     = d.amount||'';
      row.querySelector(`[data-field="event"]`).textContent      = d.event||'';
      row.querySelector(`[data-field="paymentMethod"]`).textContent = d.paymentMethod||'';
      row.querySelector(`[data-field="phone"]`).textContent      = d.phone||'';
      row.querySelector(`[data-field="email"]`).textContent      = d.email||'';
      row.querySelector(`[data-field="address"]`).textContent    = d.address||'';

      updateAnalyticsCards();
    }

    // ================== Analytics ==================
    const statTotalCount = document.getElementById('statTotalCount');
    const statTotalAmount = document.getElementById('statTotalAmount');
    const statToday = document.getElementById('statToday');
    const statByEvent = document.getElementById('statByEvent');

    function updateAnalyticsCards() {
      const totalCount = filtered.length;
      const totalAmount = filtered.reduce((s,d)=>s+Number(d.amount||0),0);
      statTotalCount.textContent = totalCount;
      statTotalAmount.textContent = '‚Çπ' + formatINR(totalAmount);

      const today = toISTISOString().slice(0,10);
      let tc=0, ta=0;
      const byEvent = {};
      filtered.forEach(d=>{
        if ((d.dateTimeISO||'').slice(0,10)===today) { tc++; ta+=Number(d.amount||0); }
        const ev = d.event||'Other';
        byEvent[ev]=(byEvent[ev]||0)+1;
      });
      statToday.textContent = `${tc} (‚Çπ${formatINR(ta)})`;
      statByEvent.innerHTML = Object.entries(byEvent).sort().map(([k,v])=>`${k}: ${v}<br>`).join('') || '-';
    }

    // ================== CSV & PDF Report ==================
    document.getElementById('downloadCSV').addEventListener('click', ()=>{
      const headers = ['Transaction ID','Date Time (IST)','Donor Name','Amount (‚Çπ)','Event','Payment Method','Phone','Email','Address'];
      const lines = [headers.join(',')];
      filtered.forEach(d=>{
        const vals = [
          d.transactionId, d.dateTimeISO, d.donorName||'', d.amount, d.event||'',
          d.paymentMethod||'', d.phone||'', d.email||'', (d.address||'').replace(/[\r\n,]+/g,' ')
        ];
        lines.push(vals.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','));
      });
      const blob = new Blob([lines.join('\n')], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download='Donation_Report.csv'; a.click(); URL.revokeObjectURL(url);
    });

    document.getElementById('downloadPDF').addEventListener('click', ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'mm', format:'a4' });
      let y=15;

      if (logoDataUrl) {
        doc.addImage(logoDataUrl, 'JPEG', 10, 10, 20, 20, undefined, 'FAST');
        y = 15;
      }
      doc.setFontSize(16);
      doc.setTextColor(33, 41, 94);
      doc.text('Navyuvak Samiti (Kamalpur)', 40, 20);
      doc.setFontSize(12);
      doc.text('Donation Report - Filtered Export', 40, 27);

      y = 35;
      const totalAmount = filtered.reduce((s,d)=>s+Number(d.amount||0),0);
      doc.setFontSize(11);
      doc.text(`Total Donations: ${filtered.length}`, 10, y); y+=6;
      doc.text(`Total Amount: INR ${formatINR(totalAmount)}`, 10, y); y+=10;

      doc.setFontSize(10);
      doc.setFillColor(240, 240, 240);
      doc.rect(10, y-5, 190, 8, 'F');
      doc.text('TxnID', 12, y); doc.text('Date (IST)', 30, y); doc.text('Donor', 80, y); doc.text('Amount (‚Çπ)', 130, y, { align: 'right' }); doc.text('Event', 150, y); y+=8;
      doc.setLineWidth(0.2);
      doc.line(10, y-2, 200, y-2); y+=2;

      filtered.forEach(d=>{
        if (y>270){ doc.addPage(); y=20; }
        doc.text(String(d.transactionId||''),12,y);
        doc.text(String(d.dateTimeISO||''),30,y);
        doc.text(String((d.donorName||'').slice(0,30)),80,y);
        doc.text(`‚Çπ${formatINR(d.amount||0)}`,130,y, { align: 'right' });
        doc.text(String((d.event||'').slice(0,25)),150,y);
        y+=6;
      });

      doc.save('Donation_Report.pdf');
    });

    // ================== Receipt PDF (New Design: Modern, with borders and colors) ==================
    function generateReceiptPDF(d) {
      const { jsPDF } = window.jspdf;
      // A5 size for better mobile viewing
      const doc = new jsPDF({ unit:'mm', format:'a5' });
      let y=10;

      // Background gradient (simulate with rects)
      doc.setFillColor(245, 248, 255);
      doc.rect(0, 0, 148, 210, 'F');

      // Logo
      if (logoDataUrl) {
        const w = 30, x = (148 - w)/2;
        doc.addImage(logoDataUrl, 'JPEG', x, y, w, w, undefined, 'FAST');
        y += w + 5;
      }

      doc.setFontSize(14);
      doc.setTextColor(33, 41, 94);
      doc.text('Navyuvak Samiti (Kamalpur)', 10, y); y+=7;
      doc.setFontSize(12);
      doc.text('Donation Receipt', 10, y); y+=5;
      doc.setDrawColor(200);
      doc.setLineWidth(0.5);
      doc.line(10, y, 138, y); y+=10;

      // Table-like rows with borders
      doc.setFontSize(10);
      doc.setTextColor(0);
      function row(label, val, isBold=false) {
        doc.setFillColor(255, 255, 255);
        doc.rect(10, y-4, 128, 8, 'F');
        doc.setDrawColor(220);
        doc.rect(10, y-4, 128, 8);
        if (isBold) doc.setFont('bold');
        doc.text(`${label}:`, 12, y);
        doc.text(String(val||'-'), 50, y);
        if (isBold) doc.setFont('normal');
        y+=8;
      }

      row('Receipt No.', d.transactionId, true);
      row('Date (IST)', d.dateTimeISO);
      row('Donor Name', d.donorName);
      row('Amount', `‚Çπ${formatINR(d.amount)}`, true);
      row('Purpose', d.event);
      row('Payment Method', d.paymentMethod);
      if (d.phone) row('Phone', d.phone);
      if (d.email) row('Email', d.email);
      if (d.address) row('Address', d.address);

      y+=5; doc.setDrawColor(200); doc.line(10, y, 138, y); y+=10;
      doc.setFontSize(9);
      doc.setTextColor(100);
      doc.text('Contact: Mobile: 9534866694 | Email: navyuwaksamitikamalpur@gmail.com', 10, y); y+=5;
      doc.text('Address: Kamalpur, Nawada, Benipur, Darbhanga', 10, y); y+=10;

      doc.setFontSize(11);
      doc.setTextColor(34, 197, 94);
      doc.text(`Thank You for Your Generous Donation!`, 10, y, { maxWidth: 128 });

      doc.save(`Receipt_${d.transactionId}.pdf`);
    }

    // ================== Events ==================
    const eventSelect = document.getElementById('event');
    const filterEventSelect = document.getElementById('filterEvent');
    const eventsTableBody = document.getElementById('eventsTableBody');

    function renderEventsUI(){
      // donation form event list (only Active)
      eventSelect.innerHTML = '';
      const active = allEvents.filter(e=>e.status==='Active');
      if (active.length===0) {
        const opt = document.createElement('option');
        opt.value = ''; opt.textContent = 'No active events';
        eventSelect.appendChild(opt);
      } else {
        active.forEach(e=>{
          const opt = document.createElement('option');
          opt.value = e.id; opt.textContent = e.name; eventSelect.appendChild(opt);
        });
      }
      // filter event (All + all events)
      renderEventsOptionsForFilters();

      // table
      eventsTableBody.innerHTML = '';
      allEvents.forEach(e=>{
        const tr = document.createElement('tr');
        tr.className='hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-4 py-3" contenteditable="true" data-etype="name" data-id="${e.id}">${e.name}</td>
          <td class="px-4 py-3">
            <select data-etype="status" data-id="${e.id}" class="border border-gray-300 rounded px-2 py-1 bg-white">
              <option ${e.status==='Active'?'selected':''}>Active</option>
              <option ${e.status==='Inactive'?'selected':''}>Inactive</option>
            </select>
          </td>
          <td class="px-4 py-3">
            <button class="text-red-600 hover:text-red-800" data-etype="delete" data-id="${e.id}">Delete</button>
          </td>
        `;
        eventsTableBody.appendChild(tr);
      });
    }

    document.getElementById('eventForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = document.getElementById('eventName').value.trim();
      const status = document.getElementById('eventStatus').value;
      if (!name) return;
      await eventsCol().add({ name, status, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      document.getElementById('eventName').value='';
      await refreshAll(); renderAfterFilters();
    });

    eventsTableBody.addEventListener('change', async (e)=>{
      const sel = e.target;
      const id = sel.getAttribute('data-id');
      const type = sel.getAttribute('data-etype');
      if (type==='status') {
        await eventsCol().doc(id).update({ status: sel.value });
        await refreshAll(); renderAfterFilters();
      }
    });
    eventsTableBody.addEventListener('blur', async (e)=>{
      const cell = e.target;
      if (cell.matches('[contenteditable="true"]')) {
        const id = cell.getAttribute('data-id');
        const val = cell.innerText.trim();
        await eventsCol().doc(id).update({ name: val });
        await refreshAll(); renderAfterFilters();
      }
    }, true);
    eventsTableBody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if (!btn) return;
      const id = btn.getAttribute('data-id');
      if (btn.getAttribute('data-etype')==='delete') {
        const ev = allEvents.find(x=>x.id===id);
        if (!ev) return;
        if (['Saraswati Puja','General Fund','Other'].includes(ev.name)) {
          return alert('Default event cannot be deleted.');
        }
        const ok = confirm(`Delete event "${ev.name}"?`); if(!ok) return;
        await eventsCol().doc(id).delete();
        await refreshAll(); renderAfterFilters();
      }
    });

    // ================== Data Management ==================
    document.getElementById('resetCounterBtn').addEventListener('click', async ()=>{
      const ok = confirm('Reset transaction counter to 0?'); if(!ok) return;
      await metaDoc().set({ lastTrx: 0 }, { merge:true });
      alert('Counter reset.');
    });

    document.getElementById('restoreDefaultEventsBtn').addEventListener('click', async ()=>{
      await ensureDefaultEvents();
      await refreshAll(); renderAfterFilters();
      alert('Default events restored (will not delete existing).');
    });

    document.getElementById('clearAllDataBtn').addEventListener('click', async ()=>{
      const ok = confirm('This will DELETE ALL donations and NON-DEFAULT events. Continue?'); if(!ok) return;
      // delete donations (batching naive)
      const dSnap = await donationsCol().get();
      const batchSize = 400;
      let idx=0;
      while (idx<dSnap.size) {
        const batch = db.batch();
        dSnap.docs.slice(idx, idx+batchSize).forEach(doc=>batch.delete(doc.ref));
        await batch.commit(); idx+=batchSize;
      }
      // delete events except defaults
      const defaults = ['Saraswati Puja','General Fund','Other'];
      const eSnap = await eventsCol().get();
      idx=0;
      const toDel = eSnap.docs.filter(doc=>!defaults.includes((doc.data().name||'')));
      while (idx<toDel.length) {
        const batch = db.batch();
        toDel.slice(idx, idx+batchSize).forEach(doc=>batch.delete(doc.ref));
        await batch.commit(); idx+=batchSize;
      }
      await metaDoc().set({ lastTrx: 0 }, { merge:true });
      await ensureDefaultEvents();
      await refreshAll(); renderAfterFilters();
      alert('All donations cleared, counter reset, defaults restored.');
    });

    // ================== Render Helpers ==================
    function renderEventsOptionsForFilters() {
      filterEventSelect.innerHTML = '';
      const allOpt = document.createElement('option'); allOpt.value=''; allOpt.textContent='All Events';
      filterEventSelect.appendChild(allOpt);
      allEvents.forEach(e=>{
        const opt = document.createElement('option');
        opt.value = e.id; opt.textContent = `${e.name} (${e.status})`;
        filterEventSelect.appendChild(opt);
      });
    }
  </script>
</body>
</html>
